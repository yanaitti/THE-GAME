<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>THE GAME(ザ・ゲーム) ONLINE</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <div id='app2'>
      <button id='createGame'>ゲームを作る(Make a Game)</button><br/>
      Game ID: <span id='gId'></span><br/>
      <hr/>
      <button id="joinGame">ゲームに参加する(Join the Game)</button><br/>
      <input id="gId_inp" placeholder="GameIDを入力してください"><br/>
      <input id="cName_inp" placeholder="ニックネームを入力してください"><br/>
      Your ID: <span id='cId'></span><br/>
      Your Name: <span id='cName'></span><br/>
      Game Status: <span id='gStatus'></span><br/>
      <div id='sec1' style='display:none'>
        <hr/>
        <button id="startGame">ゲームを始める(Let's start the Game)</button><br/>
        <h2>Member Routation</h2>
        <span id='routeList'></span>
      </div>
      <div id='sec2' style='display:none'>
        <hr/>
        <button id="status">カードを確認する(Check the cards)</button><br/>
        Your Turn: <span id='yTurn'></span><br/>
        Your Cards:<br/>
        <span id='holdCards'></span><br/>
        <hr/>
        Game Cards:<br/>
        <span id='gameCards'></span><br/>
        <hr/>
      </div>
      <div id='sec3' style='display:none'>
        <select id="area">
          <option value="0">[0]100 -> 2</option>
          <option value="1">[1]100 -> 2</option>
          <option value="2">[2]1 -> 99</option>
          <option value="3">[3]1 -> 99</option>
        </select>
        <input id="cardNum_inp" placeholder="番号を入力してください"><br/>
        <button id="putCard">カードを出す(Put the cards)</button><br/>
        <br/>
        <button id="nextPlayer">次の人へ(Go on Next user)</button><br/>
      </div>
      <br/>
      <span id='message'></span><br/>
    </div>

    <script>
    var timeout = 3000;

    $(function() {
      var gId = '';
      var cId = '';
      var timer = '';

      // Create Game
      $('#createGame').click(function() {
        $.ajax('create',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $('#gId').text(data);
          $('#cId').text(data);
          $('#cName').text(data);
          $('#gStatus').text('waiting');
          gId = data;
          cId = data;
          $('#sec1').show()
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Join Game
      $('#joinGame').click(function() {
        $.ajax($('#gId_inp').val() + '/join/' + $('#cName_inp').val(),
          {
            type: 'get',
          }
        )
        .done(function(data) {
          _tmp = data.split(' ,');
          $('#cId').text(_tmp[0]);
          $('#cName').text(_tmp[1]);
          $('#gStatus').text(_tmp[2]);
          gId = $('#gId_inp').val();
          cId = _tmp[0];
          timer = setTimeout(timer_check(gId, cId), timeout)
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Start Game
      $('#startGame').click(function() {
        $.getJSON(gId + '/start',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $('#routeList').empty();
          for(var j in data){
            $('#routeList').append(data[j] + '<br/>')
          }
          timer = setTimeout(timer_check(gId, cId), timeout)
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Check Your Status
      $('#status').click(function() {
        members_status(gId, cId);
        cards_check(gId);
      });

      // Put your card
      $('#putCard').click(function() {
        // put your card
        $.ajax(gId + '/' + cId + '/set/' + $('#area').val() + '/' + $('#cardNum_inp').val(),
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $('#message').text(data);
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });

        members_status(gId, cId);
        cards_check(gId);
      });

      // Next player
      $('#nextPlayer').click(function() {
        $.ajax(gId + '/next',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          console.log(data)
          $('#message').text('次の人に移動しました');
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

    });

    var timer_check = function(gId, cId){
      console.log('timer_check');
      setTimeout(function(){
        console.log('timer_check in');
        game_status(gId)
        if($('#gStatus').text() == 'started'){
          $('#sec2').show()
          members_status(gId, cId)
          cards_check(gId)

          if($('#yTurn').text() == 'your turn'){
            $('#sec3').show();
          }else{
            $('#sec3').css('display', 'none');
          }
        }else if($('#gStatus').text() == 'waiting'){
          $('#sec2').css('display', 'none');
        }
        timer = setTimeout(timer_check(gId, cId), timeout)
      }, timeout);
    }

    function game_status(gId){
      // members status
      $.ajax(gId + '/status',
        {
          type: 'get',
        }
      )
      .done(function(data) {
        console.log(data)
        $('#gStatus').text(data)
      })
      .fail(function() {
        $('#message').text('エラーが発生しました');
      });
    }

    function members_status(gId, cId){
      // members status
      $.getJSON(gId + '/' + cId + '/status',
        {
          type: 'get',
        }
      )
      .done(function(data) {
        console.log(data)
        if(data.turn){
          $('#yTurn').text('your turn')
        }else{
          $('#yTurn').text('not your turn')
        }
        $('#holdCards').text(data.holdcards.join(','))
      })
      .fail(function() {
        $('#message').text('エラーが発生しました');
      });
    }

    function cards_check(gId){
      // game caards check
      $.getJSON(gId + '/cardlists',
        {
          type: 'get',
        }
      )
      .done(function(data) {
        console.log(data)
        $('#gameCards').empty();
        for(var j in data){
          $('#gameCards').append('[' + j + ']:' + data[j] + '<br/>')
        }
      })
      .fail(function() {
        $('#message').text('エラーが発生しました');
      });
    }

    </script>
  </body>
</html>
